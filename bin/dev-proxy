#!/usr/bin/zsh

PORTS=(3000 3001 5173)

# Build tunnels array
TUNNELS=()
for port in "${PORTS[@]}"; do
  TUNNELS+=("-L" "${port}:localhost:${port}")
done

start() {
  # Prompt for password (hidden input)
  read -s "SSHPASS?Enter SSH password for $DESKTOP: "

  # Run ssh with sshpass
  sshpass -p "$SSHPASS" ssh -N "${TUNNELS[@]}" "akisarou@$DESKTOP" &
  echo $! >/tmp/ssh-proxy.pid
  echo "SSH tunnel started (PID $(cat /tmp/ssh-proxy.pid))"
}

stop() {
  if [[ -f /tmp/ssh-proxy.pid ]]; then
    kill "$(cat /tmp/ssh-proxy.pid)" 2>/dev/null
    rm /tmp/ssh-proxy.pid
    echo "SSH tunnel stopped"
  else
    echo "No running SSH tunnel found"
  fi
}

case "$1" in
start) start ;;
stop) stop ;;
restart)
  stop
  start
  ;;
*) echo "Usage: $0 {start|stop|restart}" ;;
esac
